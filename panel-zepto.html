<!DOCTYPE html>

<html>
<head>
<title>XHR2 Upload Panel</title>
<link rel="stylesheet" type="text/css" href="panel.css" />
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/zepto/1.1.4/zepto.min.js"></script>
<script type="text/javascript">
// User options
var USE_CLIENT_PROGRESS = true;
var MAX_FILESIZE = "5M";

// Global constants
var LISTED_LANG = ["zh-tw"];
var MAX_FILESIZE_BYTES = 0;
var TERMS = null;

// Global resources
var xhr2 = new XMLHttpRequest();
var abort_flag = false;
var upload_files = null;

$(document).ready(function() {
	loadLanguage();

	// Step 1
	var nullHandler = function(e) { e.preventDefault(); return false; };
	$(window).on("dragover", nullHandler);
	$(window).on("drop", nullHandler);
	$("#drop_area").on("dragover", nullHandler);

	// Drag & Drop
	$("#drop_area").on("dragenter", function(e) {
		e.preventDefault();
		$(this).addClass("add_files");
	});
	$("#drop_area").on("dragleave", function(e) {
		e.preventDefault();
		$(this).removeClass("add_files");
	});
	$("#drop_area").on("drop", function(e) {
		e.preventDefault();
		$(this).removeClass("add_files");
		upload_files = e.dataTransfer.files;
		listFiles();
	});

	// Click button
	$("#queue_list > .prompt > .step1 button[term=open]").click(function() {
		$("#file_list").trigger("click");
	});
	$("#file_list").on("change", function() {
		upload_files = $("#file_list")[0].files;
		listFiles();
	});

	// Step 2
	$("#queue_list > .prompt > .step2 > .sure").click(startUpload);
	$("#queue_list > .prompt > .step2 > .cancel").click(function() {
		$("#queue_list > .item").remove();
		$("#queue_list > .prompt > .step2").hide();
		$("#queue_list > .prompt > .step1").show();
	});

	// Step 3
	$("#queue_list > .prompt > .step3 > .abort").click(function() {
		abort_flag = true;
		xhr2.abort();
		$("#queue_list > .prompt > .step3").hide();
		$("#queue_list > .prompt > .step5").show();
	});
});

var loadLanguage = function() {
	//-------------------------------------
	// console.log(navigator.language);
	// console.log(navigator.userLanguage);
	//-------------------------------------
	//  Chrome 37: zh-TW / undefined
	// Firefox 32: zh-TW / undefined
	// Safari 7.1: zh-tw / undefined
	//      IE 11: zh-TW / zh_TW
	//-------------------------------------

	var lang = navigator.language.toLowerCase();
	if (LISTED_LANG.indexOf(lang)>-1) {
		var url = "i18n/" + lang + ".json";
		$.getJSON(url, function(terms) {
			document.title = terms["title"];
			for (key in terms) {
				var term = terms[key];
				var q = "[term={KEY}]".replace("{KEY}",key);
				$(q).text(term);
			}
			TERMS = terms;
		});
	}
};

var listFiles = function() {
	if (upload_files.length>0) {
		var i;

		for (i=0;i<upload_files.length;i++) {
			var f = upload_files[i];
			var item = $("#hidden_elements > .item").clone();
			var status;

			if (!isLargeThenLimit(f.size)) {
				status = (TERMS!=null) ? TERMS["ready"] : "Ready";
			} else {
				status = (TERMS!=null) ? TERMS["exceed"] : "Exceed {MAX_FILESIZE}";
				status = status.replace("{MAX_FILESIZE}", MAX_FILESIZE);
				item.children("div").eq(2).children("span").removeClass("ignore");
				item.children("div").eq(2).children("span").addClass("error");
			}

			item.insertBefore("#queue_list > .prompt");
			item.children("div").eq(0).text(f.name);
			item.children("div").eq(1).text(properSize(f.size));
			item.children("div").eq(2).children("span").text(status);
		}

		$("#queue_list > .prompt > .step1").hide();
		$("#queue_list > .prompt > .step2").show();
	}
};

var startUpload = function() {
	var f, i, next_pos;

	var pending = (TERMS!=null) ? TERMS["pending"] : "Pending";
	for (i=0;i<upload_files.length;i++) {
		f = upload_files[i];
		if (!isLargeThenLimit(f.size)) {
			$(".item").eq(i).children("div").eq(2).children("span").text(pending);
		}
	}

	var nextStep = function() {
		if (abort_flag) {
			var target;
			var aborted = (TERMS!=null) ? TERMS["aborted"] : 'Aborted';
			while (i<upload_files.length) {
				f = upload_files[i];
				if (!isLargeThenLimit(f.size)) {
					target = $(".item").eq(i).children("div").eq(2);
					target.html("");
					$("<span></span>").text(aborted).addClass("error").appendTo(target);
				}
				i++;
			}
		} else {
			var prev_pos = next_pos;

			if (++i<upload_files.length) {
				$("#progress_bar").val(0);
				$("#progress_text").text(0);

				f = upload_files[i];
				if (!isLargeThenLimit(f.size)) {
					next_pos = $(".item").eq(i).children("div").last();
					next_pos.html("");
					next_pos.append($("#progress_view"));
					uploadSingleFile(f, nextStep);
				} else {
					nextStep();
				}
			} else {
				$("#queue_list > .prompt > .step3").hide();
				$("#queue_list > .prompt > .step4").show();
				$("#progress_view").appendTo("#hidden_elements");
			}

			var done = (TERMS!=null) ? TERMS["done"] : "Done";
			if (prev_pos.html()=="") prev_pos.html('<span class="good">'+done+'</span>');
		}
	};

	$("#queue_list > .prompt > .step2").hide();
	$("#queue_list > .prompt > .step3").show();

	i = 0;
	f = upload_files[i];
	next_pos = $(".item").eq(i).children("div").last();
	if (!isLargeThenLimit(f.size)) {
		next_pos.html("");
		next_pos.append($("#progress_view"));
		uploadSingleFile(f, nextStep);
	} else {
		nextStep();
	}
};

var uploadSingleFile = function(fileObj, nextStep) {
	var formData = new FormData();
	formData.append("upload", fileObj);
	xhr2.open("post", "/upload-request", true);

	// Upload complete or error
	xhr2.onreadystatechange = function()  {
		if (xhr2.readyState==4) {
			switch(xhr2.status) {
				case 200:
					$("#progress_bar").val(100);
					$("#progress_text").text(100);
					break;
				default:
					$("#progress_bar").val(0);
					$("#progress_text").text(0);
			}

			if (!USE_CLIENT_PROGRESS) {
				clearInterval(itv);
			}

			nextStep();
		}
	};

	// Client progress - HTML5 style (recommanded)
	if (USE_CLIENT_PROGRESS) {
		xhr2.upload.onprogress = function(e) {
			var percentage = Math.floor(100*e.loaded/e.total); // IE
			$("#progress_bar").val(percentage);
			$("#progress_text").text(percentage);
		};
	}

	// Server progress - Nginx upload progress module
	if (!USE_CLIENT_PROGRESS) {
		// generate an UUID
		var i;
		var uuid128 = "";
		for(i=0;i<8;i++) {
			uuid128 += Math.floor((1+Math.random())*0x10000).toString(16).substring(1);
			if ([1,2,3,4].indexOf(i)>-1) uuid128 += "-";
		}

		// trace progress by UUID
		xhr2.setRequestHeader("X-Progress-ID", uuid128);
		var itv = setInterval(function() {
			$.ajax({
				url: "/upload-progress",
				type: "get",
				dataType: "json",
				headers: {"X-Progress-ID": uuid128},
				success: function(progress) {
					if (progress.state=="uploading") {
						var percentage = Math.floor(100*progress.received/progress.size);
						$("#progress_bar").val(percentage);
						$("#progress_text").text(percentage);
					} else {
						if (window.console!=undefined) {
							console.error(progress.state);
						}
					}
				}
			});
		}, 500);
	}

	// Send upload request
	xhr2.send(formData);
};

var isLargeThenLimit = function(filesize) {
	if (MAX_FILESIZE_BYTES==0) {
		var size_unit = MAX_FILESIZE.substr(-1);
		MAX_FILESIZE_BYTES = parseInt(MAX_FILESIZE);
		switch (size_unit) {
			case 'G':
				MAX_FILESIZE_BYTES *= 1024;
			case 'M':
				MAX_FILESIZE_BYTES *= 1024;
			case 'K':
				MAX_FILESIZE_BYTES *= 1024;
		}
	}

	return (filesize>MAX_FILESIZE_BYTES);
};

var properSize = function(filesize) {
	var unit_ptr = 0;
	var units = ['Bytes', 'KB', 'MB', 'GB'];

	while(filesize>=1024 && unit_ptr+1<units.length) {
		filesize = filesize/1024;
		unit_ptr++;
	}

	filesize += "";
	var dotpos = filesize.indexOf(".");
	if (dotpos!=-1) {
		filesize = filesize.substring(0,dotpos+3);
	}

	return filesize + " " + units[unit_ptr];
};
</script>
</head>

<body>

<div id="queue_list">
	<div class="label">
		<div term="filename">Filename</div>
		<div term="size">Size</div>
		<div term="progress">Progress</div>
	</div>
	<div class="prompt">
		<div class="step1">
			<div id="drop_area">
				<span term="step1-1">Drag files here to upload.</span><br/>
				<span term="step1-2">You can also click this button to open.</span>
				<button term="open">Open files</button>
			</div>
		</div>
		<div class="step2">
			<span term="step2">Are you ready to upload?</span>
			<button class="sure" term="sure">Sure</button> 
			<button class="cancel" term="cancel">Cancel</button>
		</div>
		<div class="step3">
			<span term="step3">Uploading is in progress.</span>
			<button class="abort" term="abort">Abort</button>
		</div>
		<div class="step4">
			<span term="step4">Everything has been uploaded.</span>
		</div>
		<div class="step5">
			<span term="step5">You have aborted this transmission.</span>
		</div>
	</div>
</div>

<div id="hidden_elements">
	<!-- File input element, hidden it because it's so ugly. -->
	<input id="file_list" type="file" multiple>
	<!-- Progress bar & percentage text, it will be moved while upload started. -->
	<div id="progress_view">
		<progress id="progress_bar" min="0" max="100" value="0"></progress>
		<span id="progress_text">0</span>%
	</div>
	<!-- File info item, it will be cloned to #queue_list while files are selected. -->
	<div class="item">
		<div>{NAME}</div>
		<div>{SIZE}</div>
		<div><span class="ignore">{PROGRESS}</span></div>
	</div>
</div>

</body>

</html>